<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>₦1M Breakout</title>

<style>
:root{
  --bg:#0b0b0d;
  --text:rgba(255,255,255,0.92);
  --muted:rgba(255,255,255,0.55);
  --surface:rgba(255,255,255,0.035);
  --surface2:rgba(255,255,255,0.025);
  --border:rgba(255,255,255,0.08);
  --borderStrong:rgba(255,255,255,0.18);
  --shadow:0 12px 30px rgba(0,0,0,0.35);
  --shadow2:0 10px 22px rgba(0,0,0,0.30);
}

*{
  box-sizing:border-box;
  transition:
    background-color .15s ease,
    border-color .15s ease,
    box-shadow .15s ease,
    transform .15s ease,
    opacity .15s ease;
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  color:var(--text);
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "SF Pro Text",
    "SF Pro Display",
    "Segoe UI",
    Inter,
    system-ui,
    sans-serif;
}

header{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:18px;
}

h1{
  margin:0;
  font-size:28px;
  font-weight:600;
  letter-spacing:-0.02em;
}

.sub{
  margin-top:6px;
  font-size:13px;
  color:var(--muted);
}

.headerBtns{
  display:flex;
  gap:10px;
  align-items:center;
}

button{
  background:#fff;
  color:#0b0b0d;
  border:none;
  border-radius:999px;
  padding:10px 16px;
  font-weight:600;
  letter-spacing:.2px;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.35);
}
button:hover{ transform:translateY(-1px); }
button:active{ transform:translateY(0px); opacity:0.92; }

button.secondary{
  background:rgba(255,255,255,0.08);
  color:var(--text);
  border:1px solid var(--border);
  box-shadow:none;
}
button.secondary:hover{ background:rgba(255,255,255,0.11); transform:translateY(-1px); }

.topbar{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  align-items:flex-end;
  margin:14px 0 18px;
}

.card{
  background:var(--surface);
  backdrop-filter: blur(12px);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px 18px;
  min-width:175px;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.04),
    var(--shadow);
}

.card h3{
  margin:0;
  font-size:12px;
  font-weight:600;
  color:var(--muted);
  letter-spacing:.04em;
  text-transform:uppercase;
}

.card .val{
  margin-top:8px;
  font-size:22px;
  font-weight:650;
  letter-spacing:-0.01em;
}

.progressWrap{ margin-top:10px; }
.progress{
  width:100%;
  height:10px;
  background:rgba(255,255,255,0.06);
  border-radius:999px;
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
}
.bar{
  height:100%;
  width:0%;
  background:rgba(255,255,255,0.85);
  opacity:0.9;
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 10px;
}

thead th{
  text-align:center;
  font-size:12px;
  font-weight:600;
  color:var(--muted);
  padding:6px 8px;
  letter-spacing:.03em;
}

tbody tr{
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.03),
    var(--shadow2);
}

tbody td{
  padding:10px 8px;
  text-align:center;
  vertical-align:middle;
}

tbody tr td:first-child{ border-top-left-radius:16px; border-bottom-left-radius:16px; }
tbody tr td:last-child{ border-top-right-radius:16px; border-bottom-right-radius:16px; }

input, select{
  width:120px;
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:10px;
  padding:7px 10px;
  font-size:13px;
}

input::placeholder{ color:rgba(255,255,255,0.35); }

input:focus, select:focus{
  outline:none;
  border-color:var(--borderStrong);
}

.note input{ width:180px; }
.odds input{ width:90px; }

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:650;
  display:inline-block;
  border:1px solid rgba(255,255,255,0.06);
}

.badge.win{ background: rgba(52,211,153,.12); color:#6ee7b7; }
.badge.loss{ background: rgba(248,113,113,.12); color:#fca5a5; }
.badge.be{ background: rgba(147,197,253,.12); color:#93c5fd; }

.smallHint{
  color:var(--muted);
  font-size:12px;
  margin-top:10px;
}

.saveDot{
  display:inline-block;
  width:8px;height:8px;border-radius:999px;
  background:rgba(255,255,255,0.22);
  margin-left:8px;
  vertical-align:middle;
}
.saveDot.ok{ background:rgba(52,211,153,.7); }
.saveDot.err{ background:rgba(248,113,113,.8); }

.statusLine{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

<header>
  <div>
    <h1>₦1M Breakout</h1>
    <div class="sub">Headies & Harry · Shared tracker (Google Sheets backend) · Breakeven after first 10 winning days</div>
  </div>
  <div class="headerBtns">
    <button class="secondary" id="reloadBtn" type="button">Reload</button>
    <button id="addBtn" type="button">Add Game Day</button>
  </div>
</header>

<div class="topbar">
  <div class="card">
    <h3>Total Played Days</h3>
    <div class="val" id="totalDays">0</div>
  </div>

  <div class="card">
    <h3>Total Wins Overall</h3>
    <div class="val" id="totalWins">0</div>
  </div>

  <div class="card">
    <h3>Headies Win Rate</h3>
    <div class="val" id="headiesRate">0%</div>
  </div>

  <div class="card">
    <h3>Harry Win Rate</h3>
    <div class="val" id="harryRate">0%</div>
  </div>

  <div class="card">
    <h3>Wins to Breakeven</h3>
    <div class="val" id="beWins">0 / 10</div>
    <div class="progressWrap">
      <div class="progress"><div class="bar" id="beBar"></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Current Balance</h3>
    <div class="val">₦<span id="balance">1,000,000</span></div>
  </div>
</div>

<table id="tracker">
  <thead>
    <tr>
      <th>#</th>
      <th>Date</th>
      <th>Headies Stake</th>
      <th>Headies Odds</th>
      <th>Harry Stake</th>
      <th>Harry Odds</th>
      <th>Total Stake</th>
      <th>Total Return</th>
      <th>P / L</th>
      <th>Cumulative</th>
      <th>Balance</th>
      <th>Win?</th>
      <th>Winner</th>
      <th>Counts in 10?</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="statusLine" id="statusLine">Status: idle</div>
<div class="smallHint">Edits save automatically. Reload pulls the latest data from the shared Google Sheet.</div>

<script>
(() => {
  const STARTING_CAPITAL = 1000000;

  // ✅ Your Apps Script Web App URL
  const API_URL = "https://script.google.com/macros/s/AKfycbxD59C5mDEVAumJy-O4NyE54QNdq2ZEN05wy3KhsJrlOlEMmoYyy5yrRKW1eqT9LGTW/exec";

  const $ = (id) => document.getElementById(id);
  const tbody = () => document.querySelector("#tracker tbody");
  const pct = (n) => (isFinite(n) ? (n * 100).toFixed(0) : "0") + "%";

  const saveTimers = new WeakMap(); // per-row debounce timers

  function setStatus(msg){ $("statusLine").textContent = "Status: " + msg; }

  function isPlayedRow(row){
    const dateVal = row.cells[1].querySelector("input").value;
    const headiesStake = Number(row.cells[2].querySelector("input").value || 0);
    const harryStake   = Number(row.cells[4].querySelector("input").value || 0);
    const ret          = Number(row.cells[7].querySelector("input").value || 0);
    const stake = headiesStake + harryStake;
    return !!dateVal || stake > 0 || ret > 0;
  }

  function payloadFromRow(row){
    return {
      _rowNumber: row.dataset.rowNumber ? Number(row.dataset.rowNumber) : 0,
      Date: row.cells[1].querySelector("input").value,
      HeadiesStake: row.cells[2].querySelector("input").value,
      HeadiesOdds: row.cells[3].querySelector("input").value,
      HarryStake: row.cells[4].querySelector("input").value,
      HarryOdds: row.cells[5].querySelector("input").value,
      TotalReturn: row.cells[7].querySelector("input").value,
      Winner: row.cells[12].querySelector("select").value,
      Notes: row.cells[14].querySelector("input").value
    };
  }

  async function saveRow(row){
    // Only save rows that look like real entries
    if (!isPlayedRow(row)) return;

    const dot = row._saveDot;
    if (dot) { dot.className = "saveDot"; }

    try{
      setStatus("saving…");
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payloadFromRow(row)) // no custom headers → avoids preflight pain
      });

      const out = await res.json().catch(() => ({}));

      if (out && out.ok && out._rowNumber){
        row.dataset.rowNumber = String(out._rowNumber);
        if (dot) dot.className = "saveDot ok";
        setStatus("saved");
      } else {
        if (dot) dot.className = "saveDot err";
        setStatus("save failed (bad response)");
      }
    } catch(err){
      if (dot) dot.className = "saveDot err";
      setStatus("save failed (network/permissions)");
    }
  }

  function scheduleSave(row){
    if (saveTimers.has(row)) clearTimeout(saveTimers.get(row));
    const t = setTimeout(() => saveRow(row), 650);
    saveTimers.set(row, t);
  }

  function addRowWithData(data = {}){
    const tr = document.createElement("tr");
    tr.dataset.rowNumber = data._rowNumber ? String(data._rowNumber) : "";

    tr.innerHTML = `
      <td></td>
      <td><input type="date" value="${escapeAttr(data.Date)}"></td>

      <td><input type="number" min="0" inputmode="numeric" placeholder="₦" value="${escapeAttr(data.HeadiesStake)}"></td>
      <td class="odds"><input type="number" step="0.01" min="1" inputmode="decimal" placeholder="e.g. 5" value="${escapeAttr(data.HeadiesOdds)}"></td>

      <td><input type="number" min="0" inputmode="numeric" placeholder="₦" value="${escapeAttr(data.HarryStake)}"></td>
      <td class="odds"><input type="number" step="0.01" min="1" inputmode="decimal" placeholder="e.g. 3" value="${escapeAttr(data.HarryOdds)}"></td>

      <td></td>

      <td><input type="number" min="0" inputmode="numeric" placeholder="₦" value="${escapeAttr(data.TotalReturn)}"></td>
      <td></td>
      <td></td>
      <td></td>

      <td></td>

      <td>
        <select>
          <option value="" ${sel(data.Winner,"")}>—</option>
          <option value="Headies" ${sel(data.Winner,"Headies")}>Headies</option>
          <option value="Harry" ${sel(data.Winner,"Harry")}>Harry</option>
          <option value="Both" ${sel(data.Winner,"Both")}>Both</option>
          <option value="None" ${sel(data.Winner,"None")}>None</option>
        </select>
        <span class="saveDot"></span>
      </td>

      <td></td>
      <td class="note"><input placeholder="optional" value="${escapeAttr(data.Notes)}"></td>
    `;

    // store a reference to the dot (inside the Winner cell)
    tr._saveDot = tr.cells[12].querySelector(".saveDot");

    tbody().appendChild(tr);

    tr.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("input", () => { recalc(); scheduleSave(tr); });
      el.addEventListener("change", () => { recalc(); scheduleSave(tr); });
    });

    recalc();
  }

  function escapeAttr(v){
    if (v === null || v === undefined) return "";
    return String(v).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function sel(val, target){
    return String(val || "") === String(target) ? "selected" : "";
  }

  async function loadFromSheet(){
    setStatus("loading…");
    try{
      const res = await fetch(API_URL);
      const out = await res.json();
      const data = (out && out.ok && Array.isArray(out.data)) ? out.data : [];

      tbody().innerHTML = "";
      data.forEach(r => addRowWithData(r));

      // If sheet is empty, start with one blank row
      if (data.length === 0) addRowWithData({});

      recalc();
      setStatus("loaded");
    } catch(err){
      setStatus("load failed (check Apps Script access: Anyone)");
      // still give user a blank row so UI isn't dead
      if (tbody().children.length === 0) addRowWithData({});
    }
  }

  function recalc(){
    const rows = document.querySelectorAll("#tracker tbody tr");

    let cumulative = 0;
    let overallWinDays = 0;
    let beCount = 0;
    let playedDays = 0;

    let headiesDays = 0;
    let harryDays = 0;

    let headiesWins = 0;
    let harryWins = 0;

    rows.forEach((row, i) => {
      const dateVal = row.cells[1].querySelector("input").value;

      const headiesStake = Number(row.cells[2].querySelector("input").value || 0);
      const harryStake   = Number(row.cells[4].querySelector("input").value || 0);
      const ret          = Number(row.cells[7].querySelector("input").value || 0);

      const stake = headiesStake + harryStake;
      const pnl = ret - stake;

      const isPlayed = !!dateVal || stake > 0 || ret > 0;
      if (isPlayed) playedDays++;

      if (isPlayed && headiesStake > 0) headiesDays++;
      if (isPlayed && harryStake > 0) harryDays++;

      cumulative += pnl;
      const balance = STARTING_CAPITAL + cumulative;

      const isWin = pnl > 0;
      if (isWin) overallWinDays++;

      let countsBE = false;
      if (isWin && overallWinDays <= 10){
        countsBE = true;
        beCount++;
      }

      const winner = row.cells[12].querySelector("select").value;
      if (isPlayed){
        if (winner === "Headies" && headiesStake > 0) headiesWins++;
        if (winner === "Harry" && harryStake > 0) harryWins++;
        if (winner === "Both"){
          if (headiesStake > 0) headiesWins++;
          if (harryStake > 0) harryWins++;
        }
      }

      row.cells[0].textContent = i + 1;
      row.cells[6].textContent = stake.toLocaleString();
      row.cells[8].textContent = pnl.toLocaleString();
      row.cells[9].textContent = cumulative.toLocaleString();
      row.cells[10].textContent = balance.toLocaleString();

      row.cells[11].innerHTML = isWin
        ? `<span class="badge win">WIN</span>`
        : `<span class="badge loss">LOSS</span>`;

      row.cells[13].innerHTML = countsBE
        ? `<span class="badge be">YES</span>`
        : `—`;
    });

    const headiesRate = headiesDays ? (headiesWins / headiesDays) : 0;
    const harryRate   = harryDays ? (harryWins / harryDays) : 0;

    $("totalDays").textContent = playedDays;
    $("totalWins").textContent = overallWinDays;
    $("beWins").textContent = `${beCount} / 10`;
    $("balance").textContent = (STARTING_CAPITAL + cumulative).toLocaleString();

    $("headiesRate").textContent = pct(headiesRate);
    $("harryRate").textContent = pct(harryRate);

    $("beBar").style.width = Math.min(100, (beCount / 10) * 100) + "%";
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("addBtn").addEventListener("click", () => addRowWithData({}));
    $("reloadBtn").addEventListener("click", loadFromSheet);
    loadFromSheet();
  });
})();
</script>

</body>
</html>
